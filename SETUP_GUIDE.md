# Инструкция по настройке связи с базой данных и Telegram ботом

## Что было сделано:

1. **Автоматическое создание пользователей** - API теперь автоматически создает пользователя при первом обращении, если его нет в базе данных
2. **Настройка API URL** - фронтенд автоматически определяет URL API в зависимости от окружения
3. **HTTP сервер на всех интерфейсах** - API сервер теперь слушает на `0.0.0.0:8080` для доступа извне

## Как запустить:

### 1. Установите зависимости:
```bash
pip install -r requirements.txt
```

### 2. Создайте файл `.env` с токеном бота:
```
BOT_TOKEN=ваш_токен_бота
DATABASE_PATH=pershcoin.db
```

### 3. Запустите бота и API сервер:
```bash
python main.py
```

Бот запустится и API сервер будет доступен на `http://localhost:8080` (или на вашем сервере)

## Настройка для продакшна:

### Если API на том же домене:
В `webapp/script.js` измените:
```javascript
API_BASE = `${protocol}//${hostname}`;
```

### Если API на другом домене:
В `webapp/script.js` укажите полный URL:
```javascript
API_BASE = 'https://your-api-domain.com';
```

## Проверка работы:

1. **Локально (localhost):**
   - Откройте `webapp/index.html` через Live Server
   - API должен быть доступен на `http://localhost:8080`
   - Приложение будет работать в демо режиме (без initData)

2. **В Telegram:**
   - Запустите бота командой `/start`
   - Откройте WebApp через кнопку в боте
   - Приложение автоматически подключится к API и создаст пользователя

## API Endpoints:

- `GET /api/user?initData=...` - получить данные пользователя (создает пользователя если его нет)
- `POST /api/tap` - обработать тап (body: `{"initData": "..."}`)
- `GET /api/leaderboard?initData=...` - получить лидерборд
- `GET /api/referrals?initData=...` - получить список рефералов

## Реферальная система:

- При регистрации по реферальной ссылке новый пользователь получает **500 монет**
- Реферер получает **1000 монет** за приглашение
- Реферер получает **15%** от каждого тапа реферала

## База данных:

База данных SQLite создается автоматически в файле `pershcoin.db` при первом запуске.

Таблицы:
- `users` - пользователи (coins, taps, referral_code, referred_by)
- `referrals` - реферальные связи (referrer_id, referred_id, coins_earned)
